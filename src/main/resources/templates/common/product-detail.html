<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <meta content="Codescandy" name="author"/>

    <title th:text="${product.name} + ' - FreshCart'">Shop Single eCommerce HTML Template - FreshCart</title>

    <!-- CSS -->
    <link th:href="@{/assets/libs/dropzone/dist/min/dropzone.min.css}" rel="stylesheet"/>
    <link th:href="@{/assets/libs/tiny-slider/dist/tiny-slider.css}" rel="stylesheet"/>
    <link rel="shortcut icon" type="image/x-icon" th:href="@{/assets/images/favicon/favicon.ico}"/>
    <link th:href="@{/assets/libs/bootstrap-icons/font/bootstrap-icons.min.css}" rel="stylesheet"/>
    <link th:href="@{/assets/libs/feather-webfont/dist/feather-icons.css}" rel="stylesheet"/>
    <link th:href="@{/assets/libs/simplebar/dist/simplebar.min.css}" rel="stylesheet"/>
    <link th:href="@{/assets/css/theme.min.css}" rel="stylesheet"/>

    <style>
        /* Vùng slider ảnh to */
        .product-slider {
            position: relative;
            overflow: hidden;
        }

        #productSlider .zoom img {
            width: 100%;
            height: auto;
            display: block;
        }

        /* Dải thumbnail bên dưới */
        .product-thumbs {
            margin-top: .75rem;
        }

        .thumbs-row {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: .5rem;
        }

        .thumb {
            border: 2px solid transparent;
            border-radius: .5rem;
            overflow: hidden;
            cursor: pointer;
            aspect-ratio: 1 / 1;
            display: block;
        }

        .thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .thumb.active {
            border-color: #198754;
        }

        /* màu viền khi chọn */
    </style>
</head>

<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>

<script th:src="@{/assets/js/vendors/validation.js}"></script>

<main>
    <!-- Breadcrumb -->
    <div class="mt-4">
        <div class="container">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a th:href="@{/}">Home</a></li>
                        <li class="breadcrumb-item" th:if="${product.categoryName != null}">
                            <a th:href="@{'/categories/' + ${product.categoryId}}" th:text="${product.categoryName}">Category</a>
                        </li>
                        <li class="breadcrumb-item active" aria-current="page" th:text="${product.name}">Product Name
                        </li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <!-- Product -->
    <section class="mt-8">
        <div class="container">
            <div class="row">
                <!-- Gallery -->
                <div class="col-md-5 col-xl-6">
                    <!-- Slider ảnh to -->
                    <div class="product-slider">
                        <div id="productSlider">
                            <div th:each="media : ${product.media}" th:if="${media.type == 'image'}"
                                 th:with="u=${#strings.startsWith(media.url, '/uploads') ? media.url : '/uploads/' + media.url}">
                                <div class="zoom" onmousemove="zoom(event)" th:style="|background-image: url(@{${u}})|">
                                    <img th:src="@{${u}}" alt="Product image"/>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Thumbnails -->
                    <div class="product-thumbs">
                        <div id="productThumbs" class="thumbs-row">
                            <a class="thumb"
                               th:each="media,iter : ${product.media}"
                               th:if="${media.type == 'image'}"
                               th:data-index="${iter.index}"
                               th:with="u=${#strings.startsWith(media.url, '/uploads') ? media.url : '/uploads/' + media.url}">
                                <img th:src="@{${u}}" alt="Thumb"/>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Info -->
                <div class="col-md-7 col-xl-6">
                    <div class="ps-lg-10 mt-6 mt-md-0">
                        <a class="mb-4 d-block" th:href="@{'/categories/' + ${product.categoryId}}"
                           th:text="${product.categoryName}" th:if="${product.categoryName != null}">Bakery Biscuits</a>

                        <h1 class="mb-1" th:text="${product.name}">Product name</h1>

                        <div class="mb-4">
                            <small class="text-warning">
                                  <span th:each="star : ${#numbers.sequence(1,5)}">
                                    <i class="bi"
                                       th:classappend="${
                                           star <= T(java.lang.Math).floor(product.avgRating)
                                               ? 'bi-star-fill text-warning'
                                               : (star - product.avgRating < 1 && star > product.avgRating
                                                   ? 'bi-star-half text-warning'
                                                   : 'bi-star text-warning')
                                       }"></i>
                                  </span>
                            </small>
                            <a href="#reviews-tab-pane" class="ms-2"
                               th:text="'(' + ${product.totalReviews} + ' reviews)'">(0 reviews)</a>
                        </div>

                        <div class="fs-4">
              <span class="fw-bold text-dark"
                    th:text="${#numbers.formatDecimal(product.price, 1, 'POINT', 0, 'POINT')} + ' đ'">
                0 đ
              </span>
                        </div>

                        <hr class="my-6"/>

                        <div>
                            <div class="input-group input-spinner">
                                <input type="button" value="-" class="button-minus btn btn-sm" data-field="quantity"/>
                                <input type="number" step="1" max="10" value="1" name="quantity"
                                       class="quantity-field form-control-sm form-input"/>
                                <input type="button" value="+" class="button-plus btn btn-sm" data-field="quantity"/>
                            </div>
                        </div>

                        <div class="mt-3 row justify-content-start g-2 align-items-center">
                            <div class="col-xxl-4 col-lg-4 col-md-5 col-5 d-grid">
                                <button type="button" class="btn btn-primary">
                                    <i class="feather-icon icon-shopping-bag me-2"></i> Add to cart
                                </button>
                            </div>
                            <div class="col-md-4 col-4">
                                <a class="btn btn-light" href="#" data-bs-toggle="tooltip" aria-label="Compare">
                                    <i class="bi bi-arrow-left-right"></i></a>
                                <a class="btn btn-light" href="#" data-bs-toggle="tooltip" aria-label="Wishlist">
                                    <i class="feather-icon icon-heart"></i></a>
                            </div>
                        </div>

                        <hr class="my-6"/>
                        <div>
                            <table class="table table-borderless mb-0">
                                <tbody>
                                <tr>
                                    <td>Product Code:</td>
                                    <td th:text="${product.productId}">FBB00255</td>
                                </tr>
                                <tr>
                                    <td>Availability:</td>
                                    <td th:text="${product.stock > 0 ? 'In Stock' : 'Out of Stock'}">In Stock</td>
                                </tr>
                                <tr th:if="${product.categoryName != null}">
                                    <td>Type:</td>
                                    <td th:text="${product.categoryName}">Fruits</td>
                                </tr>
                                <!--                                <tr><td>Seller:</td><td th:text="${product.shopId}"><small>01 day shipping. <span class="text-muted">[Seller Name]</span></small></td></tr>-->
                                </tbody>
                            </table>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Tabs -->
    <section class="mt-lg-14 mt-8">
        <div class="container">
            <div class="row">
                <div class="col-md-12">

                    <ul class="nav nav-pills nav-lb-tab" id="myTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="product-tab" data-bs-toggle="tab"
                                    data-bs-target="#product-tab-pane" type="button" role="tab">Product Details
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="reviews-tab" data-bs-toggle="tab"
                                    data-bs-target="#reviews-tab-pane" type="button" role="tab">Reviews
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="myTabContent">
                        <div class="tab-pane fade show active" id="product-tab-pane" role="tabpanel">
                            <div class="my-8">
                                <h4 class="mb-1">Product Details</h4>
                                <p class="mb-0" th:text="${product.description}" style="white-space: pre-line;"></p>


                            </div>
                        </div>

                        <!-- Reviews -->
                        <div class="tab-pane fade" id="reviews-tab-pane" role="tabpanel">
                            <div class="my-8">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="mb-10">
                                            <div th:if="${#lists.isEmpty(reviews)}"
                                                 class="text-center p-5 border rounded">
                                                <p class="mb-0">This product has no reviews yet. Be the first to write
                                                    one!</p>
                                            </div>

                                            <div th:each="review : ${reviews}" class="d-flex border-bottom pb-6 mb-6">
                                                <img th:src="@{/assets/images/avatar/avatar-placeholder.jpg}"
                                                     alt="User avatar" class="rounded-circle avatar-lg"/>
                                                <div class="ms-5">
                                                    <h6 th:text="${review.userName}">[Reviewer Name]</h6>
                                                    <p class="small text-muted"
                                                       th:text="${#temporals.format(review.createdAt, 'dd MMMM yyyy')}">
                                                        01 January 2025</p>

                                                    <div class="mb-2">
                            <span th:each="star : ${#numbers.sequence(1, 5)}">
                              <i class="bi"
                                 th:classappend="${star <= review.rating} ? 'bi-star-fill text-warning' : 'bi-star text-warning'"></i>
                            </span>
                                                    </div>

                                                    <p th:text="${review.comment}">[Review comment]</p>

                                                    <div class="d-flex">
                                                        <div th:each="media : ${review.media}"
                                                             class="border icon-shape icon-lg border-2 ms-1"
                                                             th:with="u=${#strings.startsWith(media.url, '/uploads') ? media.url : '/uploads/' + media.url}">
                                                            <img th:src="@{${u}}" alt="Review media" class="img-fluid"
                                                                 th:if="${media.type == 'IMAGE'}"/>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div> <!-- reviews-tab-pane -->
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<footer class="footer"></footer>

<!-- JS -->
<script th:src="@{/assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/assets/libs/tiny-slider/dist/min/tiny-slider.js}"></script>
<script th:src="@{/assets/js/theme.min.js}"></script>
<script th:src="@{/assets/js/vendors/jquery.min.js}"></script>

<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function () {
        // === Slider tự động chạy: 10 giây đổi ảnh, KHÔNG có nút điều hướng ===
        let productTns = null;
        try {
            if (window.tns) {
                productTns = tns({
                    container: '#productSlider',
                    items: 1,
                    slideBy: 1,
                    controls: false,          // bỏ nút < >
                    nav: false,
                    autoplay: true,           // tự chạy
                    autoplayTimeout: 10000,   // 10 giây
                    autoplayButtonOutput: false,
                    mouseDrag: true,
                    gutter: 0
                });
            }
        } catch (e) {
            console.error('Lỗi khởi tạo tiny-slider:', e);
        }

        // === Đồng bộ thumbnail ===
        const thumbs = Array.from(document.querySelectorAll('#productThumbs .thumb'));

        function setActiveThumb(i) {
            thumbs.forEach(t => t.classList.remove('active'));
            if (thumbs[i]) thumbs[i].classList.add('active');
        }

        thumbs.forEach(t => {
            t.addEventListener('click', () => {
                const idx = Number(t.getAttribute('data-index') || 0);
                if (productTns) productTns.goTo(idx);
                setActiveThumb(idx);
            });
        });
        setActiveThumb(0);
        if (productTns) {
            productTns.events.on('indexChanged', info => {
                const realIndex = info.displayIndex - 1;
                setActiveThumb(realIndex);
            });
        }
    });
</script>
<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function () {
        const contextPath = /*[[@{/}]]*/ '/';
        if (window.jQuery && window.jQuery.fn.slick) {
            $('.deals-slider').slick({
                infinite: true,
                slidesToShow: 3,
                slidesToScroll: 3,
                arrows: true,
                dots: false,
                prevArrow: '<button type="button" class="slick-prev"><i class="bi bi-chevron-left"></i></button>',
                nextArrow: '<button type="button" class="slick-next"><i class="bi bi-chevron-right"></i></button>',
                autoplay: true,
                autoplaySpeed: 10000,
                responsive: [
                    {breakpoint: 1200, settings: {slidesToShow: 2, slidesToScroll: 2}},
                    {breakpoint: 768, settings: {slidesToShow: 1, slidesToScroll: 1}}
                ]
            });
        } else {
            console.error("jQuery hoặc Slick Slider chưa được nạp. Slider 'deals-slider' sẽ không hoạt động.");
        }
        const TOKEN_KEY = 'authToken';
        const urlParams = new URLSearchParams(window.location.search);
        const isLogout = urlParams.get('logout');

        if (isLogout === 'true') {
            console.log('Phát hiện logout=true, đang dọn dẹp Local Storage...');
            localStorage.removeItem(TOKEN_KEY);
            localStorage.removeItem('userId');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('userFullName');
            localStorage.removeItem('userRole');
            window.history.replaceState({}, document.title, "/");
        }
        const token = localStorage.getItem(TOKEN_KEY);

        if (token) {
            const apiUrl = contextPath + 'api/auth/me';

            fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Token không hợp lệ');
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById('nav-cart-anonymous').classList.add('d-none');
                    document.getElementById('nav-user-anonymous').classList.add('d-none');
                    document.getElementById('nav-cart-authenticated').classList.remove('d-none');
                    document.getElementById('nav-user-authenticated').classList.remove('d-none');
                    const shopLink = document.getElementById('nav-shop-link');
                    if (shopLink) {
                        if (data.shop) {
                            shopLink.href = contextPath + 'shop';
                        } else {
                            shopLink.href = contextPath + 'shop/register';
                        }
                    }

                    const logoutButton = document.getElementById('nav-logout-button');
                    if (logoutButton) {
                        logoutButton.addEventListener('click', function (e) {
                            e.preventDefault();
                            localStorage.removeItem(TOKEN_KEY);
                            localStorage.removeItem('userId');
                            localStorage.removeItem('userEmail');
                            localStorage.removeItem('userFullName');
                            localStorage.removeItem('userRole');
                            window.location.href = contextPath;
                        });
                    }
                })
                .catch(error => {
                    console.error('Lỗi khi gọi API /me hoặc token không hợp lệ:', error);
                    localStorage.removeItem(TOKEN_KEY);
                });
        } else {
            console.log('Không tìm thấy token, người dùng chưa đăng nhập.');
        }
    });
</script>
</body>
</html>