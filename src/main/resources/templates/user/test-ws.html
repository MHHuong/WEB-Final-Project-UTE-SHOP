<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebSocket Per-User Test (JWT)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        input, button { padding: 10px; margin: 4px 0; border-radius: 4px; border: 1px solid #ddd; }
        input { width: 100%; box-sizing: border-box; }
        button { background: #007bff; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .row { margin-bottom: 12px; }
        label { display: block; font-weight: bold; margin-bottom: 4px; color: #333; }
        #log { border: 1px solid #ddd; padding: 10px; height: 300px; overflow: auto; background: #fafafa; font-family: monospace; font-size: 12px; }
        .ok { color: green; }
        .err { color: #b30000; }
        .info { color: #0066cc; }
        .section { margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 4px; }
        h2 { color: #333; margin-top: 0; }
        h3 { color: #555; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
        .status { padding: 8px; border-radius: 4px; margin: 10px 0; font-weight: bold; }
        .status.connected { background: #d4edda; color: #155724; }
        .status.disconnected { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
<div class="container">
    <h2>üöÄ Test WebSocket Per-User Orders (JWT)</h2>
    <div id="statusBar" class="status disconnected">‚ùå Disconnected</div>

    <div class="section">
        <h3>1Ô∏è‚É£ Connection (JWT Required)</h3>
        <div class="row">
            <label>JWT Token (l·∫•y t·ª´ localStorage sau khi login):</label>
            <input id="jwtToken" type="text" placeholder="Paste your JWT token here or leave empty to auto-load from localStorage" />
            <small style="color: #666;">Token s·∫Ω t·ª± ƒë·ªông l·∫•y t·ª´ localStorage('token') n·∫øu ƒë·ªÉ tr·ªëng</small>
        </div>
        <div class="row">
            <button id="connectBtn">üîå Connect with JWT</button>
            <button id="disconnectBtn" disabled>üî¥ Disconnect</button>
        </div>
    </div>

    <div class="section">
        <h3>2Ô∏è‚É£ Test Send Message</h3>
        <div class="row">
            <label>Target User ID (ng∆∞·ªùi nh·∫≠n):</label>
            <input id="sendUserId" type="text" placeholder="e.g. 1" value="1" />
        </div>
        <div class="row">
            <label>Message:</label>
            <input id="sendMessage" type="text" placeholder="Test message" value="Hello from WebSocket!" />
        </div>
        <div class="row">
            <button id="sendBtn">üì§ Send Test Message (GET)</button>
        </div>
    </div>

    <div class="section">
        <h3>3Ô∏è‚É£ Test Order Status Update</h3>
        <div class="row">
            <label>Order ID:</label>
            <input id="orderId" type="number" placeholder="e.g. 1" value="1" />
        </div>
        <div class="row">
            <label>Status:</label>
            <select id="status" style="padding: 10px; width: 100%;">
                <option value="PENDING">PENDING</option>
                <option value="CONFIRMED">CONFIRMED</option>
                <option value="PROCESSING">PROCESSING</option>
                <option value="SHIPPED" selected>SHIPPED</option>
                <option value="DELIVERED">DELIVERED</option>
                <option value="CANCELLED">CANCELLED</option>
            </select>
        </div>
        <div class="row">
            <button id="updateBtn">üîÑ Update Order Status (GET)</button>
        </div>
    </div>

    <h3>üìã Event Log</h3>
    <div id="log"></div>
    <button onclick="document.getElementById('log').innerHTML = ''; log('Log cleared', 'info');" style="margin-top: 10px; background: #6c757d;">üóëÔ∏è Clear Log</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script type="module">
    let stompClient = null;
    function log(msg, cls) {
        const el = document.createElement('div');
        if (cls) el.className = cls;
        const timestamp = new Date().toLocaleTimeString();
        el.textContent = `[${timestamp}] ${msg}`;
        const logEl = document.getElementById('log');
        logEl.appendChild(el);
        logEl.scrollTop = logEl.scrollHeight;
    }

    function updateStatus(connected) {
        const statusEl = document.getElementById('statusBar');
        if (connected) {
            statusEl.textContent = '‚úÖ Connected to WebSocket';
            statusEl.className = 'status connected';
        } else {
            statusEl.textContent = '‚ùå Disconnected';
            statusEl.className = 'status disconnected';
        }
    }

    function connect() {
        // Get JWT token from input or localStorage
        let token = document.getElementById('jwtToken').value.trim();
        if (!token) {
            token = localStorage.getItem('authToken');
            if (!token) {
                alert('‚ö†Ô∏è JWT token not found! Please:\n1. Login first to get token\n2. Or paste token manually');
                return;
            }
            log('‚úÖ Token auto-loaded from localStorage', 'info');
        }

        log('üîå Connecting to WebSocket...', 'info');
        const socket = new SockJS("http://localhost:8082/UTE_SHOP/ws?token=" + token);
        stompClient = Stomp.over(socket);

        // Connect with JWT token in header
        stompClient.connect(
            {},
            function(frame) {
                log('‚úÖ Connected successfully!', 'ok');
                log('Frame: ' + JSON.stringify(frame), 'info');
                updateStatus(true);
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;

                // Subscribe to per-user queue
                stompClient.subscribe('/user/queue/orders', function(message) {
                    console.log('üéâ RAW MESSAGE RECEIVED:', message);
                    console.log('Message body:', message.body);

                    try {
                        const body = JSON.parse(message.body);
                        log('üì¶ ‚ú® RECEIVED ORDER UPDATE: ' + JSON.stringify(body, null, 2), 'ok');
                        console.log('Parsed message:', body);

                        // Visual alert
                        alert('üéâ Message received!\n\n' + JSON.stringify(body, null, 2));

                        // Show desktop notification if supported
                        if (Notification.permission === "granted") {
                            new Notification("Order Update", {
                                body: `Order ${body.orderId}: ${body.status}`,
                                icon: '/images/favicon/favicon.ico'
                            });
                        }
                    } catch (e) {
                        log('üì¶ Received (raw): ' + message.body, 'ok');
                        console.log('Parse error:', e);
                        alert('üì¶ Message received (raw):\n' + message.body);
                    }
                });

                log('üëÇ Subscribed to /user/queue/orders', 'info');

                // Request notification permission
                if (Notification.permission === "default") {
                    Notification.requestPermission();
                }
            },
            function(error) {
                log('‚ùå STOMP error: ' + JSON.stringify(error), 'err');
                updateStatus(false);
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
            }
        );
    }

    function disconnect() {
        if (stompClient) {
            stompClient.disconnect(() => {
                log('üî¥ Disconnected', 'ok');
                updateStatus(false);
            });
            stompClient = null;
        }
        document.getElementById('connectBtn').disabled = false;
        document.getElementById('disconnectBtn').disabled = true;
    }

    async function sendTest() {
        const userId = document.getElementById('sendUserId').value.trim();
        const message = document.getElementById('sendMessage').value.trim() || 'TEST';
        if (!userId) {
            alert('‚ö†Ô∏è Enter userId to send to');
            return;
        }

        const url = '/UTE_SHOP/api/status/ws/send?userId=' + encodeURIComponent(userId) + '&message=' + encodeURIComponent(message);
        log('üì§ Sending to userId=' + userId + '...', 'info');

        try {
            const res = await fetch(url, { method: 'GET' });
            const text = await res.text();
            log('‚úÖ GET ' + url + ' -> ' + res.status + ' ' + text, res.ok ? 'ok' : 'err');
        } catch (e) {
            log('‚ùå Failed to send: ' + e.message, 'err');
        }
    }

    async function updateOrder() {
        const orderId = document.getElementById('orderId').value.trim();
        const status = document.getElementById('status').value.trim();
        if (!orderId || !status) {
            alert('‚ö†Ô∏è Enter orderId and status');
            return;
        }

        const url = '/UTE_SHOP/api/status/ws/order-status?orderId=' + encodeURIComponent(orderId) + '&status=' + encodeURIComponent(status);
        log('üîÑ Updating order ' + orderId + ' to ' + status + '...', 'info');

        try {
            const res = await fetch(url, { method: 'GET' });
            const text = await res.text();
            log('‚úÖ GET ' + url + ' -> ' + res.status + ' ' + text, res.ok ? 'ok' : 'err');
        } catch (e) {
            log('‚ùå Failed to update: ' + e.message, 'err');
        }
    }

    document.getElementById('connectBtn').addEventListener('click', connect);
    document.getElementById('disconnectBtn').addEventListener('click', disconnect);
    document.getElementById('sendBtn').addEventListener('click', sendTest);
    document.getElementById('updateBtn').addEventListener('click', updateOrder);

    // Auto-load token on page load
    window.addEventListener('load', function() {
        const token = localStorage.getItem('authToken');
        const userId = localStorage.getItem('userId');

        console.log('=== WebSocket Test Page ===');
        console.log('Token:', token ? 'Found ‚úÖ' : 'Not found ‚ùå');
        console.log('UserId:', userId || 'Not found');

        // Display current userId
        const userIdEl = document.getElementById('currentUserId');
        if (userId) {
            userIdEl.textContent = userId;
            // Auto-fill userId in test forms
            document.getElementById('sendUserId').value = userId;
        } else {
            userIdEl.textContent = 'Not logged in';
        }

        if (token) {
            log('‚ÑπÔ∏è JWT token found in localStorage (ready to connect)', 'info');
            log('‚ÑπÔ∏è Your userId: ' + (userId || 'unknown'), 'info');
        } else {
            log('‚ö†Ô∏è No JWT token in localStorage. Please login first or paste token manually.', 'err');
        }
    });
</script>
</body>
</html>
