<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <th:block th:replace="~{fragments/layout :: head}"></th:block>
    <title>Homepage v1 - eCommerce HTML Template - FreshCart</title>
</head>

<body>

<div th:replace="~{fragments/navbar :: navbar}"></div>
<div th:replace="~{fragments/user/shopCart::shop-cart}"></div>
<div th:replace="~{fragments/layout :: modals}"></div>

<main>
    <section class="mt-8">
    </section>

    <section class="mb-lg-10 mt-lg-14 my-8">
    </section>

    <section>
    </section>

    <section class="my-lg-14 my-8">
        <div class="container">
            <div class="row">
                <div class="col-12 mb-6">
                    <h3 class="mb-0">Popular Products</h3>
                </div>
            </div>

            <div class="row g-4 row-cols-lg-5 row-cols-2 row-cols-md-3">
                <div class="col" th:each="product : ${popularProducts}">
                    <div th:replace="~{fragments/product-card :: product-card(product=${product})}"></div>
                </div>
            </div>
        </div>
    </section>
    <section>
        <div class="container">
            <div class="row">
                <div class="col-md-12 mb-6">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">Daily Best Sells</h3>
                    </div>
                </div>
            </div>

            <div class="row g-4">

                <div class="col-lg-3 d-none d-lg-block">
                    <div class="h-100 rounded"
                         th:style="'background-image: url(' + @{/assets/images/banner/banner-deal.jpg} + ');' +
                               'background-size: cover; ' +
                               'background-position: center; ' +
                               'min-height: 470px; ' +
                               'position: relative;'">

                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                            <a href="shop-grid" class="btn btn-success btn-lg">
                                Shop Now <i class="bi bi-arrow-right"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <div class="col-lg-9">
                    <div class="deals-slider">

                        <div th:each="product : ${bestSellsProducts}" class="px-2 h-100">
                            <div th:replace="~{fragments/product-card-deal :: product-card-deal(product=${product})}"></div>
                        </div>

                    </div>
                </div>

            </div>
        </div>
        <div th:replace="~{fragments/toast::toast-container}"></div>
    </section>
    <section class="my-lg-14 my-8">
    </section>
</main>

<footer th:replace="~{fragments/layout :: footer}" class="footer"></footer>

<div th:replace="~{fragments/layout :: scripts}"></div>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function () {
        const contextPath = /*[[@{/}]]*/ '/';
        if (window.jQuery && window.jQuery.fn.slick) {
            $('.deals-slider').slick({
                infinite: true,
                slidesToShow: 3,
                slidesToScroll: 3,
                arrows: true,
                dots: false,
                prevArrow: '<button type="button" class="slick-prev"><i class="bi bi-chevron-left"></i></button>',
                nextArrow: '<button type="button" class="slick-next"><i class="bi bi-chevron-right"></i></button>',
                autoplay: true,
                autoplaySpeed: 10000,
                responsive: [
                    { breakpoint: 1200, settings: { slidesToShow: 2, slidesToScroll: 2 } },
                    { breakpoint: 768, settings: { slidesToShow: 1, slidesToScroll: 1 } }
                ]
            });
        } else {
            console.error("jQuery ho·∫∑c Slick Slider ch∆∞a ƒë∆∞·ª£c n·∫°p. Slider 'deals-slider' s·∫Ω kh√¥ng ho·∫°t ƒë·ªông.");
        }
        const TOKEN_KEY = 'authToken';
        const urlParams = new URLSearchParams(window.location.search);
        const isLogout = urlParams.get('logout');

        if (isLogout === 'true') {
            console.log('Ph√°t hi·ªán logout=true, ƒëang d·ªçn d·∫πp Local Storage...');
            localStorage.removeItem(TOKEN_KEY);
            localStorage.removeItem('userId');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('userFullName');
            localStorage.removeItem('userRole');
            window.history.replaceState({}, document.title, "/");
        }
        const token = localStorage.getItem(TOKEN_KEY);

        if (token) {
            const apiUrl = contextPath + 'api/auth/me';

            fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Token kh√¥ng h·ª£p l·ªá');
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById('nav-cart-anonymous').classList.add('d-none');
                    document.getElementById('nav-user-anonymous').classList.add('d-none');
                    document.getElementById('nav-cart-authenticated').classList.remove('d-none');
                    document.getElementById('nav-user-authenticated').classList.remove('d-none');
                    const shopLink = document.getElementById('nav-shop-link');
                    if (shopLink) {
                        if (data.shop) {
                            shopLink.href = contextPath + 'shop';
                        } else {
                            shopLink.href = contextPath + 'shop/register';
                        }
                    }

                    const logoutButton = document.getElementById('nav-logout-button');
                    if (logoutButton) {
                        logoutButton.addEventListener('click', function(e) {
                            e.preventDefault();
                            localStorage.removeItem(TOKEN_KEY);
                            localStorage.removeItem('userId');
                            localStorage.removeItem('userEmail');
                            localStorage.removeItem('userFullName');
                            localStorage.removeItem('userRole');
                            window.location.href = contextPath;
                        });
                    }
                })
                .catch(error => {
                    console.error('L·ªói khi g·ªçi API /me ho·∫∑c token kh√¥ng h·ª£p l·ªá:', error);
                    localStorage.removeItem(TOKEN_KEY);
                });
        } else {
            console.log('Kh√¥ng t√¨m th·∫•y token, ng∆∞·ªùi d√πng ch∆∞a ƒëƒÉng nh·∫≠p.');
        }
    });
</script>
<script type="module">
    import cartBadgeUtils from "./js/utils/cartBadgeUtils.js";
    import {showInfoToast} from "./js/utils/toastUtils.js";

    document.addEventListener("DOMContentLoaded", function () {
        const user_id = localStorage.getItem('userId');
        console.log(user_id);
        if (user_id) {
            cartBadgeUtils.initCartBadge(user_id);
            connect(user_id);
        }
    });


    let stompClient = null;
    function connect(user_id) {
        let token = localStorage.getItem("authToken");
        if (!token) {
            return;
        }
        const socket = new SockJS("http://localhost:8082/UTE_SHOP/ws?token=" + token);
        stompClient = Stomp.over(socket);
        stompClient.connect(
            {},
            function(frame) {
                stompClient.subscribe('/user/queue/orders', function(message) {
                    try {
                        const body = JSON.parse(message.body);
                        console.log('Received message:', body);
                        if (body.orderId !== null && Number(body.userId) === Number(user_id)) {
                            showInfoToast("You have received an update for your order: #" + body.orderId + " - Status: " + body.status);
                        }
                        else if (Number(body.userId) === Number(user_id)) {
                            showInfoToast("You have a new message: " + body.status);
                        }
                    } catch (e) {
                        console.log('Parse error:', e);
                        alert('üì¶ Message received (raw):\n' + message.body);
                    }
                });
                if (Notification.permission === "default") {
                    Notification.requestPermission();
                }
            },
            function(error) {
                log('STOMP error: ' + JSON.stringify(error), 'err');
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
            });
    }
</script>
</body>
</html>