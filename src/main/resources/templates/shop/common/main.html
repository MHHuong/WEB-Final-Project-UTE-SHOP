<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <!-- HEAD dùng chung (copy block của bạn vào đây) -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta content="Codescandy" name="author">

    <link rel="shortcut icon" type="image/x-icon" th:href="@{/assets/images/favicon/favicon.ico}">
    <link th:href="@{/assets/libs/bootstrap-icons/font/bootstrap-icons.min.css}" rel="stylesheet">
    <link th:href="@{/assets/libs/feather-webfont/dist/feather-icons.css}" rel="stylesheet">
    <link th:href="@{/assets/libs/simplebar/dist/simplebar.min.css}" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/assets/css/theme.min.css}">

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-M8S4MT3EYG"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag("js", new Date());
        gtag("config", "G-M8S4MT3EYG");
    </script>
    <script type="text/javascript">
        (function (c, l, a, r, i, t, y) {
            c[a] = c[a] || function () {
                (c[a].q = c[a].q || []).push(arguments);
            };
            t = l.createElement(r);
            t.async = 1;
            t.src = "https://www.clarity.ms/tag/" + i;
            y = l.getElementsByTagName(r)[0];
            y.parentNode.insertBefore(t, y);
        })(window, document, "clarity", "script", "kuc8w5o9nt");
    </script>

    <title th:text="${pageTitle} ?: 'UTE Shop'">UTE Shop</title>
</head>
<body>
<header th:replace="~{shop/common/header :: header}"></header>

<div class="main-wrapper">
    <aside th:replace="~{shop/common/sidebar :: sidebar}"></aside>
    <main class="main-content-wrapper" layout:fragment="content">
        <!-- default content -->
    </main>
</div>
<!-- Libs JS -->
<!-- <script th:src="@{/assets/libs/jquery/dist/jquery.min.js}"></script> -->
<script th:src="@{/assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/assets/libs/simplebar/dist/simplebar.min.js}"></script>

<!-- Theme JS -->
<script th:src="@{/assets/js/theme.min.js}"></script>
<script th:src="@{/assets/js/vendors/sidebar-active.js}" defer></script>
<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function () {
        const contextPath = /*[[@{/}]]*/ '/';
        if (window.jQuery && window.jQuery.fn.slick) {
            $('.deals-slider').slick({
                infinite: true,
                slidesToShow: 3,
                slidesToScroll: 3,
                arrows: true,
                dots: false,
                prevArrow: '<button type="button" class="slick-prev"><i class="bi bi-chevron-left"></i></button>',
                nextArrow: '<button type="button" class="slick-next"><i class="bi bi-chevron-right"></i></button>',
                autoplay: true,
                autoplaySpeed: 10000,
                responsive: [
                    {breakpoint: 1200, settings: {slidesToShow: 2, slidesToScroll: 2}},
                    {breakpoint: 768, settings: {slidesToShow: 1, slidesToScroll: 1}}
                ]
            });
        } else {
            console.error("jQuery hoặc Slick Slider chưa được nạp. Slider 'deals-slider' sẽ không hoạt động.");
        }
        const TOKEN_KEY = 'authToken';
        const urlParams = new URLSearchParams(window.location.search);
        const isLogout = urlParams.get('logout');

        if (isLogout === 'true') {
            console.log('Phát hiện logout=true, đang dọn dẹp Local Storage...');
            localStorage.removeItem(TOKEN_KEY);
            localStorage.removeItem('userId');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('userFullName');
            localStorage.removeItem('userRole');
            window.history.replaceState({}, document.title, "/");
        }
        const token = localStorage.getItem(TOKEN_KEY);

        if (token) {
            const apiUrl = contextPath + 'api/auth/me';

            fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Token không hợp lệ');
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById('nav-cart-anonymous').classList.add('d-none');
                    document.getElementById('nav-user-anonymous').classList.add('d-none');
                    document.getElementById('nav-cart-authenticated').classList.remove('d-none');
                    document.getElementById('nav-user-authenticated').classList.remove('d-none');
                    const shopLink = document.getElementById('nav-shop-link');
                    if (shopLink) {
                        if (data.shop) {
                            shopLink.href = contextPath + 'shop';
                        } else {
                            shopLink.href = contextPath + 'shop/register';
                        }
                    }

                    const logoutButton = document.getElementById('nav-logout-button');
                    if (logoutButton) {
                        logoutButton.addEventListener('click', function (e) {
                            e.preventDefault();
                            localStorage.removeItem(TOKEN_KEY);
                            localStorage.removeItem('userId');
                            localStorage.removeItem('userEmail');
                            localStorage.removeItem('userFullName');
                            localStorage.removeItem('userRole');
                            window.location.href = contextPath;
                        });
                    }
                })
                .catch(error => {
                    console.error('Lỗi khi gọi API /me hoặc token không hợp lệ:', error);
                    localStorage.removeItem(TOKEN_KEY);
                });
        } else {
            console.log('Không tìm thấy token, người dùng chưa đăng nhập.');
        }
    });
</script>
</body>
</html>